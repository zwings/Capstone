<html>

<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.1.1/css/all.css" integrity="sha384-O8whS3fhG2OnA5Kas0Y9l3cfpmYjapjI0E4theH4iuMD+pLhbf6JI0jIMfYcK3yZ"
        crossorigin="anonymous">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/contentful@latest/dist/contentful.browser.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <link rel="stylesheet" href="./Shop_page.css">
</head>

<body>
        <nav id="mainNav" class="navbar navbar-expand-lg navbar-light bg-light justify-content-between">
                <div class="container-fluid">
                        <div class="search">
                            <input type="text" class="searchTerm" placeholder="Searching for a BBBird?">
        
                            <a class="searchButton" ><img src="https://i.imgur.com/R0ywva5.png" height="45px" width="45px"></a>
        
                        </div>           
                    <a href="file:///C:/Users/justi/Desktop/accelerate_exercise/Justinsoso/Capstone/index.html"><img src="https://i.imgur.com/7RpoT8x.png" height="100px" width="100px"></a>
                    <a class="navbar-header" href="file:///C:/Users/justi/Desktop/accelerate_exercise/Justinsoso/Capstone/index.html">Birdy Land</a>
                    <div class="threeIcon">
                        <ul class="socialmedia navbar-right">
                            <li>
                                <a class="fb Icon" href="#facebook">
                                    <img src="https://i.imgur.com/hPOxtPe.png" height="70px" width="70px">
                                </a>
                            </li>
                            <li>
                                <a class="yt Icon" href="#youtube">
                                    <img src="https://i.imgur.com/yOjwHO5.png" height="62px" width="62px">
                                </a>
                            </li>
                            <li>
                                <a class="ig Icon" href="#instagram">
                                    <img src="https://i.imgur.com/SKlKmTo.png" height="95px" width="95px">
                                </a>
                            </li>
                        </ul>
                    </div>
                </div>
            </nav>
    <!-- Bird icons template-->
    <div id="birds-icons-template" style="display:none;">
        <div class="img-container grid-row col-md-6 col-lg-3">
            <img class="birds-icons-img-template">
        </div>
    </div>
    <!-- Bird data card modal template-->
    <div style="display: none;">
        <div id="bird-data-template" class="modal-dialog">
            <!-- bird-dta-card content-->
            <!--Warning:never mess up with the fucking bootstrap class!!!!-->
            <div class="bird-data-modal-content modal-content">
                <div class="bird-data-modal-header modal-header">
                    <span type="button" class="close" data-dismiss="modal">&times;</span>
                    <div class="bird-data-type">Lovebird</div>
                </div>
                <div class="bird-data-modal-body modal-body">
                    <img class="bird-data-modal-image" src="background:url('')">
                </div>
                <div class="bird-data-modal-footer modal-footer">
                    <div class="bird-data-descripiton">
                        <p class="bird-data-properties">Lovebird is a small size bird, with green color feather, and it's 2 years old now.</p>
                        <span>
                            <i class="fas fa-tag fa-2x"></i>
                            <span class="bird-data-price">Price:$100</span>
                        </span>
                        <br/>
                        <!-- Add-to-cart button -->
                        <button class="bird-data-add-to-cart">
                            <span>
                                <i class="fas fa-cart-plus fa-2x"></i>
                                <span class="bird-data-add-to-cart-text">Add to Cart</span>
                            </span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Shopping cart list item template -->
    <div style="display: none;">
        <div class="shopping-cart-list-item-template">
            <span class="shopping-cart-list-item-body">
                <img class="shopping-cart-list-item-icon" scr="">
                <span class="shopping-cart-list-item-name"></span>
                <span class="shopping-cart-list-item-price"></span>
                <!--I need to add a event hanlder and funcinton for remove button-->
                <i class="shopping-cart-list-item-remove-button fas fa-minus-square"></i>
            </span>
        </div>
    </div>

    <!--Shopping cart button-->
    <i class="icon fas fa-shopping-cart fa-3x " data-toggle="modal" data-target="#shopping-cart-container"></i>
    <!--Bird icons container-->
    <div id="birds-icons-container" class="row">
    </div>
    <!--Bird data modal container-->
    <div id="bird-data-container" class="modal fade" role="dialog">
    </div>
    <!--Shopping cart modal container-->
    <div id="shopping-cart-container" class="modal fade" role="dialog">
        <div id="shopping-cart" class="modal-dialog">
            <!-- Shopping cart modal content-->
            <div class="shopping-cart-modal-content modal-content">
                <div class="shopping-cart-modal-header modal-header">
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                    <h4 class="shopping-car-modal-title modal-title">
                        <i class="fas fa-crow fa-2x"></i>
                        <span>Shopping cart</span>
                    </h4>
                </div>
                <div class="shopping-cart-modal-body modal-body">
                    <ul class="shopping-cart-list">
                        <li class="shopping-cart-list-item-none">"You haven't added any item yet"</li>
                    </ul>
                </div>
                <div class=" shopping-cart-modal-footer modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Check out</button>
                    <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                </div>
            </div>
        </div>

        <script type='text/javascript'>
            $().ready(() => {
                // Set up api call.
                let cdaClient = contentful.createClient({
                    space: "bqnchs7z0iy5",
                    accessToken: "c0685fb14294207d1308e272df9fe0da5d6651c2efec7a4ee2c519f310ddb1d2"
                });
                var birdsArr = [];
                // Get all the entires of content-type from server.
                cdaClient.getEntries({ content_type: "birdType" })
                    .then((result) => result.items)
                    .then((result) => { console.log(result); return result })
                    .then((items) => items.map((item) => item.fields))
                    .then((output) => output.map((item) => {
                        return { ...item, photo: item.photo.fields.file.url }
                    }))
                    .then((output) => output.map((item) => {
                        return { ...item, icon: item.icon.fields.file.url }
                    }))
                    .then((items) => items.forEach((item) => {
                        birdsArr.push({ ...item, id: birdsArr.length })
                    }))
                    .then(constructIcon)
                    .then(getBirdDataViaUrl);
                // For new element generated after the page loaded, you have to select its parent for adding event handler       
                // Click icon to trigger modal
                $("#birds-icons-container").click(".icons-img", function (e) {
                    console.log(e.target.id);
                    constructBirdData(e.target.id);
                });
                // Erase the data of modal while closed
                $("#bird-data-container").on('hidden.bs.modal', function (e) {
                    e.target.innerHTML = "";
                });
                // Click add-to-cart button 
                $('#bird-data-container').on('click', '.bird-data-add-to-cart', function (e) {
                    console.log('added');
                    console.log(e.target.id);
                    constructShoppingCartItem(e.target.id);
                });
                //Click remove button
                $('#shopping-cart-container').on('click', '.shopping-cart-list-item-remove-button', function (e) {
                    $(e.target).parent().remove();
                    console.log(document.getElementsByClassName('shopping-cart-list')[0].children.length)
                    if (document.getElementsByClassName('shopping-cart-list')[0].children.length === 1) {
                        $(".shopping-cart-list-item-none").css('display', 'block');
                    }
                })
                // Get corresponding Bird ID from URL
                function getParameterByName(name, url) {
                    if (!url) url = window.location.href;
                    name = name.replace(/[\[\]]/g, '\\$&');
                    var regex = new RegExp('[?&]' + name + '(=([^&#]*)|&|#|$)'),
                        results = regex.exec(url);
                    if (!results) return null;
                    if (!results[2]) return '';
                    return decodeURIComponent(results[2].replace(/\+/g, ' '));
                }
                // Create a sudo event to trigger modal via URL
                function getBirdDataViaUrl() {
                    console.log("I'm running")
                    var birdId = getParameterByName('birdId');
                    if (!!birdId) {
                        $("#birds-icons-container").children().eq(Number(birdId)).children().eq(0).click()
                    }
                };
                // Create icons by API data. 
                function constructIcon() {
                    birdsArr.forEach((e) => {
                        let iconTemplate = $('#birds-icons-template').clone();
                        let iconContainer = iconTemplate[0].children;
                        iconContainer[0].innerHTML = `<img id="img_${e.id}"class="birds-icons-img" src="http:${e.icon}">`;
                        let iconsContainer = $("#birds-icons-container");
                        iconsContainer.append(iconTemplate.html());
                    });
                }
                // Create a modal by API data
                function constructBirdData(rawTargetId) {
                    targetId = rawTargetId.substring(4);
                    data = birdsArr[Number(targetId)];
                    let dataTemplate = $("#bird-data-template").clone();
                    let dataHeader = dataTemplate[0].getElementsByClassName("bird-data-modal-header")[0];
                    let type = dataHeader.children[1];
                    type.innerHTML = `${data.type}`;
                    let dataBody = dataTemplate[0].getElementsByClassName("bird-data-modal-body")[0];
                    let image = dataBody.children[0];
                    image.src = `http:${data.photo}`;
                    let dataFooter = dataTemplate[0].getElementsByClassName("bird-data-modal-footer")[0];
                    let descripiton = dataFooter.children[0];
                    let properties = descripiton.children[0];
                    let price = descripiton.children[1].children[1];
                    properties.innerHTML = `${data.type} is a ${data.size} size bird, with ${data.color} color feather, and it's ${data.age} years old now.`;
                    price.innerHTML = `$${data.price}`;
                    let button = descripiton.children[3];
                    button.id = `button_${data.id}`;
                    console.log(`I am id ${button.id}`);
                    let dataContainer = $("#bird-data-container");
                    dataContainer.append(dataTemplate.html());
                    $('#bird-data-container').modal('show');
                };
                // Create a item by API data
                function constructShoppingCartItem(rawTargetId) {
                    targetId = rawTargetId.substring(7);
                    console.log(targetId);
                    item = birdsArr[Number(targetId)];
                    let itemTemplate = $(".shopping-cart-list-item-template").clone();
                    let itemBody = itemTemplate[0].getElementsByClassName("shopping-cart-list-item-body")[0];
                    itemBody.id = `item_${targetId}`
                    let itemIcon = itemBody.children[0];
                    let itemName = itemBody.children[1];
                    let itemPrice = itemBody.children[2];
                    itemIcon.src = `http:${item.icon}`;
                    itemName.innerHTML = `Type: ${item.type}`;
                    itemPrice.innerHTML = `Price: $${item.price}`;
                    let itemsContainer = $(".shopping-cart-list");


                    if (checkDuplicate(itemBody.id)) {
                        alert("Item already added to cart!")
                    } else {

                        $(".shopping-cart-list-item-none").css('display', 'none');
                        itemsContainer.append(itemTemplate.html());
                    }
                }

                function checkDuplicate(itemId) {
                    let itemsContainer = $(".shopping-cart-list");
                    checkingArr = itemsContainer[0].children;
                    console.log((Array.from(checkingArr).map(function (e) {
                        return e.id;
                    }).filter((id) => {
                        return id === itemId
                    }).length > 0)
                    );
                    return (Array.from(checkingArr).map(function (e) {
                        return e.id;
                    }).filter((id) => {
                        return id === itemId
                    }).length > 0)
                }

            });
        </script>
</body>


</html>